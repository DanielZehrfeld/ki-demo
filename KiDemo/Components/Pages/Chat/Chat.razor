@page "/chat"
@using KiDemo.Backend
@rendermode InteractiveServer

<PageTitle>Chat</PageTitle>

<div class="chat-container">
	<div class="item-list">
		@foreach (var message in _messages)
		{
			<button class="list-item" @onclick="() => SelectMessage(message.Id)">@message.DisplayName</button>
		}
	</div>

	<div class="main-area">
		<div class="input-area">
			<input type="text" @bind="_messageTextToSubmit" placeholder="Enter text..." />
			<button class="btn btn-primary" @onclick="AddItem">Submit</button>
		</div>

		<div class="content-area">
			<textarea readonly>@_selectedMessageContent</textarea>
		</div>
	</div>
</div>

@inject ChatVm ViewModel

@code {
	private List<MessageItemVm> _messages = new List<MessageItemVm>();


	private string _messageTextToSubmit = string.Empty;
	private string _selectedMessageContent = string.Empty;

	protected override void OnInitialized()
	{

		ViewModel.MessageItems.Subscribe(OnMessagesChanged);
		ViewModel.MessageDetails.Subscribe(OnMessageDetails);
		ViewModel.ServiceState.Subscribe(OnServiceState);

		ViewModel.StateHasChanged.Subscribe(_ => InvokeAsync(StateHasChanged));
	}

	private void OnMessagesChanged(MessageItemVm[] messages)
	{
		_messages = messages.ToList();
	}

	private void OnMessageDetails(MessageDetailsVm messageDetails)
	{
		_selectedMessageContent = messageDetails.MessageContent;
	}

	private void OnServiceState(ServiceStateVm serviceState)
	{


	}

	private void AddItem()
	{
		if (!string.IsNullOrWhiteSpace(_messageTextToSubmit))
		{
			ViewModel.SubmitMessage(_messageTextToSubmit);
			_messageTextToSubmit = string.Empty;
		}
	}

	private void SelectMessage(Guid messageId)
	{
		ViewModel.SelectMessage(messageId);
	}
}